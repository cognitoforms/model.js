!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.exomodel={})}(this,function(t){"use strict";var a="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function e(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function n(t,e){return t(e={exports:{}},e.exports),e.exports}var u=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.unsub=t,this.propagationStopped=!1}return t.prototype.stopPropagation=function(){this.propagationStopped=!0},t}();e.EventManagement=n});e(u);u.EventManagement;var o=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){this.handler=t,this.isOnce=e,this.isExecuted=!1}return t.prototype.execute=function(t,e,n){if(!this.isOnce||!this.isExecuted){this.isExecuted=!0;var r=this.handler;t?setTimeout(function(){r.apply(e,n)},1):r.apply(e,n)}},t}();e.Subscription=n});e(o);o.Subscription;var r=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){this._wrap=new i(this),this._subscriptions=new Array}return t.prototype.subscribe=function(t){var e=this;return t&&this._subscriptions.push(new o.Subscription(t,!1)),function(){e.unsubscribe(t)}},t.prototype.sub=function(t){return this.subscribe(t)},t.prototype.one=function(t){var e=this;return t&&this._subscriptions.push(new o.Subscription(t,!0)),function(){e.unsubscribe(t)}},t.prototype.has=function(e){return!!e&&this._subscriptions.some(function(t){return t.handler==e})},t.prototype.unsubscribe=function(t){if(t)for(var e=0;e<this._subscriptions.length;e++)if(this._subscriptions[e].handler==t){this._subscriptions.splice(e,1);break}},t.prototype.unsub=function(t){this.unsubscribe(t)},t.prototype._dispatch=function(r,i,o){for(var s=this,t=function(t){var e=new u.EventManagement(function(){return s.unsub(t.handler)}),n=Array.prototype.slice.call(o);if(n.push(e),t.execute(r,i,n),a.cleanup(t),!r&&e.propagationStopped)return"break"},a=this,e=0,n=this._subscriptions.slice();e<n.length;e++){if("break"===t(n[e]))break}},t.prototype.cleanup=function(t){if(t.isOnce&&t.isExecuted){var e=this._subscriptions.indexOf(t);-1<e&&this._subscriptions.splice(e,1)}},t.prototype.asEvent=function(){return this._wrap},t.prototype.clear=function(){this._subscriptions.splice(0,this._subscriptions.length)},t}();e.DispatcherBase=n;var r=function(){function t(){this._events={}}return t.prototype.get=function(t){var e=this._events[t];return e||(e=this.createDispatcher(),this._events[t]=e)},t.prototype.remove=function(t){delete this._events[t]},t}();e.EventListBase=r;var i=function(){function t(e){this._subscribe=function(t){return e.subscribe(t)},this._unsubscribe=function(t){return e.unsubscribe(t)},this._one=function(t){return e.one(t)},this._has=function(t){return e.has(t)},this._clear=function(){return e.clear()}}return t.prototype.subscribe=function(t){return this._subscribe(t)},t.prototype.sub=function(t){return this.subscribe(t)},t.prototype.unsubscribe=function(t){this._unsubscribe(t)},t.prototype.unsub=function(t){this.unsubscribe(t)},t.prototype.one=function(t){return this._one(t)},t.prototype.has=function(t){return this._has(t)},t.prototype.clear=function(){this._clear()},t}();e.DispatcherWrapper=i});e(r);r.DispatcherBase,r.EventListBase,r.DispatcherWrapper;var p=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.DispatcherBase=r.DispatcherBase,e.DispatcherWrapper=r.DispatcherWrapper,e.EventListBase=r.EventListBase,e.Subscription=o.Subscription});e(p);p.DispatcherBase,p.DispatcherWrapper,p.EventListBase,p.Subscription;var i=n(function(t,e){var r,n=a&&a.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var i=function(t){function e(){return t.call(this)||this}return n(e,t),e.prototype.dispatch=function(t,e){this._dispatch(!1,this,arguments)},e.prototype.dispatchAsync=function(t,e){this._dispatch(!0,this,arguments)},e.prototype.asEvent=function(){return t.prototype.asEvent.call(this)},e}(p.DispatcherBase);e.EventDispatcher=i;var o=function(t){function e(){return t.call(this)||this}return n(e,t),e.prototype.createDispatcher=function(){return new i},e}(p.EventListBase);e.EventList=o;var s=function(){function t(){this._events=new o}return Object.defineProperty(t.prototype,"events",{get:function(){return this._events},enumerable:!0,configurable:!0}),t.prototype.subscribe=function(t,e){this._events.get(t).subscribe(e)},t.prototype.sub=function(t,e){this.subscribe(t,e)},t.prototype.unsubscribe=function(t,e){this._events.get(t).unsubscribe(e)},t.prototype.unsub=function(t,e){this.unsubscribe(t,e)},t.prototype.one=function(t,e){this._events.get(t).one(e)},t.prototype.has=function(t,e){return this._events.get(t).has(e)},t}();e.EventHandlingBase=s});e(i);i.EventDispatcher,i.EventList,i.EventHandlingBase;var s=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.EventDispatcher=i.EventDispatcher,e.EventHandlingBase=i.EventHandlingBase,e.EventList=i.EventList});e(s);var h=s.EventDispatcher,c=(s.EventHandlingBase,s.EventList,["Object","String","Number","Boolean","Date","TimeSpan","Array"]),l=function(){function s(){this._types={},this._typeAddedEvent=new h,this._entityRegisteredEvent=new h,this._entityUnregisteredEvent=new h}return Object.defineProperty(s.prototype,"typeAdded",{get:function(){return this._typeAddedEvent.asEvent()},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"entityRegistered",{get:function(){return this._entityRegisteredEvent.asEvent()},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"entityUnregistered",{get:function(){return this._entityUnregisteredEvent.asEvent()},enumerable:!0,configurable:!0}),s.prototype.dispose=function(){},s.prototype.addType=function(t,e,n){void 0===e&&(e=null),void 0===n&&(n="client");var r=new x(this,t,e,n);return this._types[t]=r,this._typeAddedEvent.dispatch(this,{type:r}),r},s.getJsType=function(t,e){void 0===e&&(e=!1);var n=s._allTypesRoot,r=t.split(".");if(1===r.length&&-1<c.indexOf(t))return window[t];for(var i=0;i<r.length;i++){var o=r[i];if(void 0===(n=n[o])){if(e)return;throw new Error('The type "'+t+'" could not be found.  Failed on step "'+o+'".')}}return n},s._allTypesRoot={},s}(),y=function(){function e(){}return e.prototype.init=function(t,e){var n;for(var r in"string"==typeof t?(n={})[t]=e:n=t,n){var i=this.meta.type.property(r);if(!i)throw new Error('Could not find property "'+r+'" on type "'+this.meta.type.fullName+'".');i.value(this,e)}},e.prototype.set=function(t,e){var n;for(var r in"string"==typeof t?(n={})[t]=e:n=t,n){var i=this.meta.type.property(r);if(!i)throw new Error('Could not find property "'+r+'" on type "'+this.meta.type.fullName+'".');i.set(this,e,!1)}},e.prototype.get=function(t){return this.meta.type.property(t).value(this)},e.prototype.toString=function(t){return t?t.convert(this):e.toIdString(this)},e.toIdString=function(t){return t.meta.type.get_fullName()+"|"+t.meta.id},e.fromIdString=function(t){var e=t.substring(0,t.indexOf("|")),n=t.substring(e.length+1);return l.getJsType(e).meta.get(n,!1)},e}();function d(t,e){var n,r=e;return r.constructor===String?(n=r.split("."),r=window,n.forEach(function(t){if(void 0===(r=r[t]))throw new Error('Parent namespace "'+e+'" could not be found.')})):null==r&&(r=window),t in r?r[t]:r[t]={}}var f=/function\s*([\w_\$]*)/i;var v=/\s([a-z|A-Z]+)/;function b(t){return void 0===t?"undefined":null===t?"null":Object.prototype.toString.call(t).match(v)[1].toLowerCase()}function g(t,e){void 0===t&&(t=0),void 0===e&&(e=9);var n=Math.random();return 1===n?e:Math.floor(n*(e-t+1))+t}var _={secrets:{}};var m=function(t,e){return(m=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};var w=function(o){function t(t,e){void 0===e&&(e=null);var n=o.apply(this,e)||this;return n.owner=t,n}return function(t,e){function n(){this.constructor=t}m(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}(t,o),t.prototype.push=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=o.prototype.push.call(t);return this.changedEvent.dispatch(this.owner,{added:t,removed:[]}),n},t.prototype.pop=function(){var t=o.prototype.pop.call(this);return this.changedEvent.dispatch(this.owner,{added:[],removed:[t]}),t},t.prototype.unshift=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=o.prototype.unshift.call(t);return this.changedEvent.dispatch(this.owner,{added:t,removed:[]}),n},t.prototype.splice=function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var i=o.prototype.splice.call(t,e,n);return this.changedEvent.dispatch(this.owner,{added:n,removed:i}),i},t.prototype.shift=function(){var t=o.prototype.shift.call(this);return this.changedEvent.dispatch(this.owner,{added:[],removed:[t]}),t},t.prototype.sort=function(){return o.prototype.sort.call(this),this.changedEvent.dispatch(this.owner,{added:[],removed:[]}),this},t.prototype.reverse=function(){var t=o.prototype.reverse.call(this);return this.changedEvent.dispatch(this.owner,{added:[],removed:[]}),t},t.prototype.remove=function(t){var e=this.indexOf(t);return-1<e&&this.splice(e,1),-1<e},Object.defineProperty(t.prototype,"changed",{get:function(){return this.changedEvent.asEvent()},enumerable:!0,configurable:!0}),t}(Array),E=function(t,e,n,r,i){var o;if(void 0===e&&(e=8),void 0===n&&(n=!0),void 0===r&&(r=!1),void 0===i&&(i=null),_.secrets.hasOwnProperty(t))(o=_.secrets[t]).indexOf(i);else{var s="";if(n)s=function(t,e){void 0===e&&(e=!1);for(var n="",r=0;r<t;r++){var i,o=g(0,e?35:25);i=o<=25?o+97:o-26+48,n+=String.fromCharCode(i)}return n}(e,r);else if(r)for(var a=0;a<e;a++)s+=g(0,9).toString();o=i?i+s:s,_.secrets[t]=o}return o}("fieldNamePrefix",3,!1,!0,"_fN"),j=function(){function e(t,e,n,r,i){this.containingType=t,this.name=e,this.jstype=n,this.isList=!0===r,this.isStatic=!0===i,this._changedEvent=new h,t.originForNewProperties&&(this._origin=t.originForNewProperties)}return Object.defineProperty(e.prototype,"fieldName",{get:function(){return E+"_"+this.name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"changed",{get:function(){return this._changedEvent.asEvent()},enumerable:!0,configurable:!0}),e.prototype.equals=function(t){if(null!=t&&t instanceof e)return this===t},e.prototype.toString=function(){return this.isStatic?this.getPath():"this<"+this.containingType+">."+this.name},e.prototype.isDefinedBy=function(t){return this.containingType===t||t.isSubclassOf(this.containingType)},Object.defineProperty(e.prototype,"origin",{get:function(){return this._origin?this._origin:this.containingType.origin},enumerable:!0,configurable:!0}),e.prototype.getPath=function(){return this.isStatic?this.containingType.fullName+"."+this.name:this.name},e.prototype.canSetValue=function(t,e){if(void 0===e)return console.warn("You should not set property values to undefined, use null instead: property = "+this.name+"."),!0;if(null===e)return!0;if(e.constructor&&e.constructor.meta){for(var n=e.constructor.meta;n;n=n.baseType)if(n.jstype===this.jstype)return!0;return!1}var r=e.constructor;switch(b(e)){case"string":r=String;break;case"number":r=Number;break;case"boolean":r=Boolean;break;case"date":r=Date;break;case"array":r=Array}return r===this.jstype||r===Array&&this.isList&&e.every(function(t){if(t.constructor&&t.constructor.meta){for(var e=t.constructor.meta;e;e=e.baseType)if(e._jstype===this._jstype)return!0;return!1}},this)},e.prototype.value=function(t,e,n){void 0===n&&(n=null);var r=this.isStatic?this.containingType.jstype:t;if(null==r)throw new Error("Cannot "+(1<arguments.length?"set":"get")+" value for "+(this.isStatic?"":"non-")+'static property "'+this.getPath()+'" on type "'+this.containingType.fullName+'": target is null or undefined.');if(!(1<arguments.length))return getPropertyValue(this,r);setPropertyValue(this,r,e,!1,n)},e.prototype.rootedPath=function(t){if(this.isDefinedBy(t))return this.isStatic?this.containingType.fullName+"."+this.name:this.name},e}();function P(t,e){var n,r;e.hasOwnProperty(t.fieldName)||function(t,e,n,r){void 0===r&&(r=!1);var i=e.isStatic?e.containingType.jstype:t;(void 0===i[e.fieldName]||void 0===r||r)&&(Object.defineProperty(i,e.fieldName,{value:n,writable:!0}),n instanceof Array&&(n=new w(t,n),e.changed.subscribe(function(t,e){})))}(e,t,(n=t.isList,r=t.jstype,n?[]:r!==Boolean&&(r===Number?0:null)))}function O(t,e){return P(t,e),e[t.fieldName]}function N(t,e,n,r,i){if(void 0===r&&(r=!1),void 0===i&&(i=null),P(t,e),!t.canSetValue(e,n))throw new Error("Cannot set "+t.name+"="+(void 0===n?"<undefined>":n)+" for instance "+e.meta.type.fullName+"|"+e.meta.id+": a value of type "+(t.jstype&&t.jstype.meta?t.jstype.meta.get_fullName():parseFunctionName(t.jstype))+" was expected.");var o=e[t.fieldName];if(t.isList)throw new Error("Property set on lists is not permitted");var s=null==o?o:o.valueOf(),a=null==n?n:n.valueOf();if(!(s===a||t.jstype===Number&&isNaN(s)&&isNaN(a))&&(e[t.fieldName]=n,void 0!==o)){var u={property:t,newValue:n,oldValue:o};if(i)for(var p in i)i.hasOwnProperty(p)&&(u[p]=i[p]);t._changedEvent.dispatch(e,u)}}var T=function(){function t(t,e,n,r){Object.defineProperty(this,"type",{value:t,writable:!1,enumerable:!0,configurable:!1}),Object.defineProperty(this,"entity",{value:e,writable:!1,enumerable:!0,configurable:!1}),Object.defineProperty(this,"id",{value:n,writable:!0,enumerable:!0,configurable:!1}),Object.defineProperty(this,"isNew",{value:r,writable:!0,enumerable:!0,configurable:!1})}return t.prototype.destroy=function(){this.type.unregister(this.entity)},t}(),S="+c",x=function(){function t(t,e,n,r){this.model=t,this.fullName=e,this._initNewEvent=new h,this._initExistingEvent=new h,this._propertyAddedEvent=new h,this._properties={},this.origin=r||"client",this.originForNewProperties=this.origin,this._pool={},this._legacyPool={},this._counter=0,Object.defineProperty(this,"rules",{value:[]});for(var i=l.getJsType(e,!0),o=e.split("."),s=o.shift(),a=l._allTypesRoot,u=window;0<o.length;)a=d(s,a),u=d(s,u),s=o.shift();var p,c,f=s;i=function(t,e,n){if(!D)if(t&&t.constructor===String){var r=t,i=p.get(r,!0);if(i)return e&&i.init(e),i;p.register(this,r,n),e&&this.init(e);for(var o=p;o;o=o.baseType)o._initExistingEvent.dispatch(o,{entity:this})}else{p.register(this,null,n),t&&this.set(t);for(var o=p;o;o=o.baseType)o._initNewEvent.dispatch(o,{entity:this})}},(p=this)._jstype=i,a[f]?a["$"+f]=i:a[f]=i,u[f]?u["$"+f]=i:u[f]=i,this.derivedTypes=[],n?(c=n._jstype,(this.baseType=n).derivedTypes.push(this)):(c=y,this.baseType=null),D=!0,this._jstype.prototype=new c,D=!1,this._jstype.prototype.constructor=this._jstype,Object.defineProperty(i,"meta",{value:this,configurable:!1,enumerable:!1,writable:!1}),t._types[e]=this}return Object.defineProperty(t.prototype,"propertyAdded",{get:function(){return this._propertyAddedEvent.asEvent()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"initNew",{get:function(){return this._initNewEvent.asEvent()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"initExisting",{get:function(){return this._initExistingEvent.asEvent()},enumerable:!0,configurable:!0}),Object.defineProperty(t,"newIdPrefix",{get:function(){return S.substring(1)},set:function(t){if("string"!=typeof t)throw new TypeError("Property `Type.newIdPrefix` must be a string, found <"+typeof t+">");if(0===t.length)throw new Error("Property `Type.newIdPrefix` cannot be empty string");S="+"+t},enumerable:!0,configurable:!0}),t.prototype.newId=function(){for(var t,e=this;e;e=e.baseType)t=Math.max(t||0,e._counter);for(e=this;e;e=e.baseType)e._counter=t+1;return S+t},t.prototype.register=function(t,e,n){var r;void 0===n&&(n=!1),2===arguments.length&&B(this,e),e||(e=this.newId(),r=!0),Object.defineProperty(t,"meta",{value:new T(this,t,e,r),configurable:!1,enumerable:!1,writable:!1});for(var i=e.toLowerCase(),o=this;o;o=o.baseType){if(o._pool.hasOwnProperty(i))throw new Error('Object "'+this.fullName+"|"+e+'" has already been registered.');o._pool[i]=t,o._known&&o._known.push(t)}n||this.model._entityRegisteredEvent.dispatch(this.model,{entity:t})},t.prototype.changeObjectId=function(t,e){B(this,t),B(this,e);var n=t.toLowerCase(),r=e.toLowerCase(),i=this._pool[n];if(i){i.meta._legacyId=t;for(var o=this;o;o=o.baseType)o._pool[r]=i,delete o._pool[n],o._legacyPool[n]=i;return i.meta.id=e,i}console.warn('Attempting to change id: Instance of type "'+this.fullName+'" with id = "'+t+'" could not be found.')},t.prototype.unregister=function(t){for(var e=this;e;e=e.baseType)delete e._pool[t.meta.id.toLowerCase()],t.meta._legacyId&&delete e._legacyPool[t.meta._legacyId.toLowerCase()],e._known&&e._known.remove(t);this.model._entityUnregisteredEvent.dispatch(this.model,{entity:t})},t.prototype.get=function(t,e){var n=t.toLowerCase(),r=this._pool[n]||this._legacyPool[n];if(r&&!0===e&&r.meta.type!==this)throw new Error("The entity with id='"+t+"' is expected to be of type '"+this.fullName+"' but found type '"+r.meta.type.fullName+"'.");return r},t.prototype.known=function(){var t=this._known;if(!t){var e=[];for(var n in this._pool)e.push(this._pool[n]);t=this._known=new w(this,e)}return t},Object.defineProperty(t.prototype,"jstype",{get:function(){return this._jstype},enumerable:!0,configurable:!0}),t.prototype.addProperty=function(t,e,n,r){var i,o,s,a,u,p,c,f,h,l=new j(this,t,e,n,r);return this._properties[t]=l,o=(i=l).containingType,s=i.isStatic?o.jstype:o.jstype.prototype,Object.defineProperty(s,i.name,{configurable:!1,enumerable:!0,get:(c=i,f=O,h=!0,void 0===h&&(h=!1),function(){var t=f(c,this,h);return t}),set:(a=i,u=N,void 0===p&&(p=!1),function(t){u(a,this,t,p)})}),this._propertyAddedEvent.dispatch(this,{property:l}),l},t.prototype.property=function(t){for(var e,n=this;n&&!e;n=n.baseType)if(e=n._properties[t])return e;return null},t.prototype.isSubclassOf=function(e){var n=!1;return function(t,e,n,r){void 0===r&&(r=null);for(var i=t[e];null!=i;i=i[e])if(!1===n.call(r||t,i))return}(this,"baseType",function(t){if(t===e)return!(n=!0)}),n},t.prototype.toString=function(){return this.fullName},t}();function B(t,e){if(null==e)throw new Error("Id cannot be "+(null===e?"null":"undefined")+" (entity = "+t.fullName+").");if("string"!==b(e))throw new Error("Id must be a string:  encountered id "+e+' of type "'+(n=e.constructor,(r=f.exec(n))&&r[1]||"{anonymous}")+'" (entity = '+t.fullName+").");if(""===e)throw new Error("Id cannot be a blank string (entity = "+t.fullName+").");var n,r}var D=!1;t.Type=x,t.Model=l,Object.defineProperty(t,"__esModule",{value:!0})});
